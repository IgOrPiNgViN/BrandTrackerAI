#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
Извлечение проблем и жалоб из отзывов
"""

import re
from typing import Dict, List, Set
from collections import Counter

class ProblemExtractor:
    """Извлекает проблемы и жалобы из отзывов"""
    
    def __init__(self):
        # Категории проблем с ключевыми словами
        self.problem_categories = {
            'качество_еды': {
                'keywords': [
                    'невкусно', 'невкусный', 'невкусная', 'невкусное',
                    'пересолено', 'пересоленный', 'пересолена',
                    'недосолено', 'недосоленный', 'недосолена',
                    'пережарено', 'пережаренный', 'пережарена',
                    'недожарено', 'недожаренный', 'недожарена',
                    'холодное', 'холодный', 'холодная',
                    'горячее', 'горячий', 'горячая',
                    'испорчено', 'испорченный', 'испорченная',
                    'просрочено', 'просроченный', 'просроченная',
                    'не свежее', 'не свежий', 'не свежая',
                    'старое', 'старый', 'старая',
                    'плохое качество', 'плохой качество',
                    'некачественный', 'некачественная', 'некачественное'
                ],
                'description': 'Проблемы с качеством еды'
            },
            'обслуживание': {
                'keywords': [
                    'медленно', 'медленный', 'медленная', 'медленное',
                    'долго ждать', 'долгое ожидание',
                    'грубо', 'грубый', 'грубая', 'грубое',
                    'невежливо', 'невежливый', 'невежливая',
                    'неприветливо', 'неприветливый', 'неприветливая',
                    'игнорируют', 'игнорируют', 'игнорирует',
                    'не обращают внимания', 'не обращают внимание',
                    'не помогли', 'не помог', 'не помогла',
                    'не обслужили', 'не обслужил', 'не обслужила',
                    'плохое обслуживание', 'плохой обслуживание',
                    'некомпетентный', 'некомпетентная', 'некомпетентное',
                    'не знают меню', 'не знает меню',
                    'ошибка в заказе', 'ошибка заказа',
                    'неправильный заказ', 'неправильная заказ'
                ],
                'description': 'Проблемы с обслуживанием'
            },
            'чистота': {
                'keywords': [
                    'грязно', 'грязный', 'грязная', 'грязное',
                    'не чисто', 'не чистый', 'не чистая',
                    'мусор', 'мусора',
                    'крошки', 'крошек',
                    'пятна', 'пятен',
                    'не убрано', 'не убрал', 'не убрала',
                    'грязная посуда', 'грязный посуда',
                    'грязные столы', 'грязный столы',
                    'не моют', 'не моет',
                    'антисанитария', 'антисанитарный',
                    'неприятный запах', 'неприятная запах',
                    'воняет', 'вонь'
                ],
                'description': 'Проблемы с чистотой'
            },
            'цены': {
                'keywords': [
                    'дорого', 'дорогой', 'дорогая', 'дорогое',
                    'завышенные цены', 'завышенный цены',
                    'неоправданно дорого', 'неоправданно дорогой',
                    'переплатил', 'переплатила', 'переплатили',
                    'не стоит денег', 'не стоят денег',
                    'завысили цену', 'завысили цены',
                    'обманули с ценой', 'обманули с ценами',
                    'дороже чем', 'дороже, чем',
                    'неадекватные цены', 'неадекватный цены',
                    'завысили', 'завысил', 'завысила'
                ],
                'description': 'Проблемы с ценами'
            },
            'ожидание': {
                'keywords': [
                    'долго ждать', 'долгое ожидание',
                    'очень долго', 'слишком долго',
                    'ждали час', 'ждали часа', 'ждали полчаса',
                    'не принесли', 'не принесли вовремя',
                    'забыли заказ', 'забыли про заказ',
                    'потеряли заказ', 'потеряли заказа',
                    'не привезли', 'не привезли вовремя',
                    'опоздали', 'опоздал', 'опоздала',
                    'задержка', 'задержки',
                    'медленно готовят', 'медленно готовит',
                    'долго готовят', 'долго готовит'
                ],
                'description': 'Проблемы с ожиданием'
            },
            'атмосфера': {
                'keywords': [
                    'шумно', 'шумный', 'шумная', 'шумное',
                    'громкая музыка', 'громкий музыка',
                    'тесно', 'тесный', 'тесная', 'тесное',
                    'душно', 'душный', 'душная', 'душное',
                    'холодно', 'холодный', 'холодная',
                    'жарко', 'жаркий', 'жаркая',
                    'неудобно', 'неудобный', 'неудобная', 'неудобное',
                    'некомфортно', 'некомфортный', 'некомфортная',
                    'плохая атмосфера', 'плохой атмосфера',
                    'неприятная обстановка', 'неприятный обстановка'
                ],
                'description': 'Проблемы с атмосферой'
            },
            'технические': {
                'keywords': [
                    'не работает', 'не работал', 'не работала',
                    'сломалось', 'сломался', 'сломалась',
                    'не работает wi-fi', 'не работает wifi',
                    'не работает карта', 'не принимают карту',
                    'не работает терминал', 'не работает терминалов',
                    'проблемы с оплатой', 'проблема оплата',
                    'не работает сайт', 'не работает приложение',
                    'технические проблемы', 'технический проблемы',
                    'сбой', 'сбои', 'сбоя'
                ],
                'description': 'Технические проблемы'
            },
            'размер_порций': {
                'keywords': [
                    'маленькие порции', 'маленький порции',
                    'мало', 'маленький', 'маленькая', 'маленькое',
                    'не наелся', 'не наелась', 'не наелись',
                    'маленькая порция', 'маленький порция',
                    'не хватило', 'не хватила',
                    'скудные порции', 'скудный порции',
                    'мало еды', 'мало еда'
                ],
                'description': 'Проблемы с размером порций'
            }
        }
    
    def extract_problems(self, text: str) -> List[Dict[str, any]]:
        """
        Извлекает проблемы из текста
        
        Args:
            text: Текст отзыва
        
        Returns:
            Список найденных проблем
        """
        if not text or not isinstance(text, str):
            return []
        
        text_lower = text.lower()
        found_problems = []
        
        for category, data in self.problem_categories.items():
            keywords = data['keywords']
            matches = [kw for kw in keywords if kw in text_lower]
            
            if matches:
                # Находим контекст проблемы (предложение с ключевым словом)
                context = self._extract_context(text, matches[0])
                
                found_problems.append({
                    'category': category,
                    'description': data['description'],
                    'keywords_found': matches,
                    'context': context,
                    'severity': self._estimate_severity(text_lower, matches)
                })
        
        return found_problems
    
    def _extract_context(self, text: str, keyword: str, context_length: int = 50) -> str:
        """Извлекает контекст вокруг ключевого слова"""
        text_lower = text.lower()
        keyword_lower = keyword.lower()
        
        if keyword_lower not in text_lower:
            return ""
        
        index = text_lower.find(keyword_lower)
        start = max(0, index - context_length)
        end = min(len(text), index + len(keyword_lower) + context_length)
        
        context = text[start:end].strip()
        # Очистка от лишних пробелов
        context = re.sub(r'\s+', ' ', context)
        
        return context
    
    def _estimate_severity(self, text: str, keywords: List[str]) -> str:
        """Оценивает серьезность проблемы"""
        # Усилители серьезности
        severe_words = ['ужасно', 'кошмар', 'отвратительно', 'невыносимо', 
                       'недопустимо', 'неприемлемо', 'катастрофа']
        
        has_severe = any(word in text for word in severe_words)
        keyword_count = len(keywords)
        
        if has_severe or keyword_count >= 3:
            return 'high'
        elif keyword_count >= 2:
            return 'medium'
        else:
            return 'low'
    
    def analyze_batch(self, texts: List[str]) -> Dict[str, any]:
        """
        Анализирует список текстов и извлекает все проблемы
        
        Args:
            texts: Список текстов отзывов
        
        Returns:
            Статистика по проблемам
        """
        all_problems = []
        for text in texts:
            problems = self.extract_problems(text)
            all_problems.extend(problems)
        
        # Подсчет проблем по категориям
        category_counts = Counter(p['category'] for p in all_problems)
        severity_counts = Counter(p['severity'] for p in all_problems)
        
        # Топ проблем
        top_problems = category_counts.most_common(10)
        
        return {
            'total_problems': len(all_problems),
            'unique_reviews_with_problems': len(set(i for i, _ in enumerate(texts) 
                                                    if self.extract_problems(texts[i]))),
            'problems_by_category': dict(category_counts),
            'problems_by_severity': dict(severity_counts),
            'top_problems': [
                {
                    'category': cat,
                    'description': self.problem_categories[cat]['description'],
                    'count': count
                }
                for cat, count in top_problems
            ],
            'all_problems': all_problems
        }
